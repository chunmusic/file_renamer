name: Build & Release File Renamer (Windows)

on:
  push:
    tags:
      - "v*.*.*"          # run when you push a tag like v1.0.0
  workflow_dispatch: {}    # allow manual run

permissions:
  contents: write          # needed to create releases

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Python + uv
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      # 3) Create venv & install only what's needed
      - name: Create venv (.venv)
        shell: pwsh
        run: |
          uv venv --python "$env:PythonLocation\python.exe"
          Get-ChildItem .venv

      - name: Install dependencies
        shell: pwsh
        run: |
          uv pip install -p .venv PySide6 pyinstaller

      # 4) Build EXE (bundle your assets/)
      # NOTE: Change entry script if your filename isn't file_renamer.py
      - name: Build PyInstaller EXE
        shell: pwsh
        run: >
          uv run -p .venv pyinstaller --onefile --windowed --noupx --clean
          --name FileRenamer
          --icon assets/app.ico
          --add-data "assets;assets"
          file_renamer.py

      - name: Verify EXE
        shell: pwsh
        run: |
          if (-not (Test-Path "dist\FileRenamer.exe")) { throw "EXE not found" }
          Get-ChildItem dist

      # 5) Install Inno Setup & build installer
      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup --no-progress -y
          if (-not (Test-Path "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe")) {
            throw "ISCC.exe not found after install"
          }

      # If you keep FileRenamer.iss in the repo root, this just works.
      # Otherwise, uncomment the next step to generate the .iss file dynamically.
      # - name: Generate Inno Setup script
      #   shell: pwsh
      #   run: |
      #     @'
      #     # SEE TEMPLATE BELOW
      #     '@ | Out-File -FilePath FileRenamer.iss -Encoding UTF8 -Force

      - name: Build Inno installer
        shell: pwsh
        run: |
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          & $iscc FileRenamer.iss /Qp
          Get-ChildItem installer

      # 6) Create GitHub Release and attach the installer .exe
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: "File Renamer ${{ github.ref_name }}"
          tag_name: "${{ github.ref_name }}"
          generate_release_notes: true
          files: |
            installer/*.exe
